<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>La Pêche du Capitaine Roro</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="text-secondary">
    <div class="container my-4 my-md-5">
      <header class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">
          La Pêche du Capitaine Roro
        </h1>
        <p class="lead text-primary-emphasis">Le jeu de pêche ultime</p>
        <div id="auth-buttons" class="d-flex justify-content-center gap-2">
          <button
            class="btn btn-outline-primary"
            data-bs-toggle="modal"
            data-bs-target="#authModal"
          >
            <i class="bi bi-person-circle"></i> Connexion / Inscription
          </button>
          <button
            id="store-btn"
            class="btn btn-outline-success"
            data-bs-toggle="modal"
            data-bs-target="#storeModal"
            disabled
          >
            <i class="bi bi-shop"></i> Magasin
          </button>
        </div>
      </header>
      <section class="mt-5">
        <h2 class="display-6 fw-bold text-primary text-center mb-4">
          Live Twitch
        </h2>
        <div class="row g-4">
          <!-- Lecteur Vidéo -->
          <div class="col-lg-8">
            <div class="card shadow-sm">
              <div class="card-header">
                <h3 class="h5 mb-0">
                  <i class="bi bi-twitch"></i> Stream en direct
                </h3>
              </div>
              <div class="card-body">
                <!-- Le conteneur pour le lecteur vidéo Twitch -->
                <div id="twitch-embed" class="twitch-embed"></div>
              </div>
            </div>
          </div>
          <!-- Chat -->
          <div class="col-lg-4">
            <div class="card shadow-sm">
              <div class="card-header">
                <h3 class="h5 mb-0"><i class="bi bi-chat-dots"></i> Chat</h3>
              </div>
              <div class="card-body p-0">
                <!-- Le conteneur pour le chat Twitch -->
                <div id="twitch-chat-embed" class="twitch-embed"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <main class="row g-4">
        <div class="col-lg-8">
          <div class="card shadow-sm h-100">
            <div class="card-header">
              <h2 class="h4 mb-0">A la pêche moussaillon !</h2>
            </div>
            <div class="card-body d-flex flex-column">
              <div
                class="game-container w-100 rounded mb-4 d-flex align-items-center justify-content-center shadow-inner flex-grow-1"
              >
                <p
                  id="game-status"
                  class="text-white h3 fw-bold bg-dark bg-opacity-50 px-3 py-2 rounded"
                >
                  Connectez-vous pour jouer !
                </p>
              </div>
              <div class="text-center">
                <button
                  id="cast-line-btn"
                  class="btn btn-primary btn-lg rounded-pill px-5 shadow"
                  disabled
                >
                  Lancer la ligne !
                </button>
              </div>
              <div
                id="message-box"
                class="mt-3 text-center fs-5 fw-semibold"
                style="height: 30px"
              ></div>
            </div>
          </div>
        </div>
        <aside class="col-lg-4">
          <div class="card shadow-sm">
            <div class="card-header"><h2 class="h4 mb-0">Mon Profil</h2></div>
            <div class="card-body">
              <div class="mb-3">
                <p class="fw-semibold">
                  Joueur :
                  <span id="player-name" class="fw-normal">Non connecté</span>
                </p>
                <p class="fw-semibold">
                  Argent : <span id="player-money" class="fw-normal">-- $</span>
                </p>
              </div>
              <div>
                <h3 class="h5 mb-2">Inventaire des Poissons</h3>
                <ul
                  id="inventory-list"
                  class="list-group"
                  style="height: 200px; overflow-y: auto"
                >
                  <li class="list-group-item text-muted">
                    Connectez-vous pour voir votre inventaire.
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </aside>
      </main>
    </div>

    <!-- Fenêtre Modale pour l'Authentification -->
    <div
      class="modal fade"
      id="authModal"
      tabindex="-1"
      aria-labelledby="authModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="authModalLabel">
              Authentification
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs" id="authTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="login-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#login-tab-pane"
                  type="button"
                  role="tab"
                >
                  Connexion
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="register-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#register-tab-pane"
                  type="button"
                  role="tab"
                >
                  Inscription
                </button>
              </li>
            </ul>
            <div class="tab-content pt-3" id="authTabContent">
              <div
                class="tab-pane fade show active"
                id="login-tab-pane"
                role="tabpanel"
              >
                <form id="login-form">
                  <div class="mb-3">
                    <label for="login-email" class="form-label">Email</label
                    ><input
                      type="email"
                      class="form-control"
                      id="login-email"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="login-password" class="form-label"
                      >Mot de passe</label
                    ><input
                      type="password"
                      class="form-control"
                      id="login-password"
                      required
                    />
                  </div>
                  <button type="submit" class="btn btn-primary w-100">
                    Se connecter
                  </button>
                </form>
                <div
                  id="login-message"
                  class="mt-3 text-center fw-semibold"
                  style="height: 24px"
                ></div>
              </div>
              <div class="tab-pane fade" id="register-tab-pane" role="tabpanel">
                <form id="register-form">
                  <div class="mb-3">
                    <label for="register-email" class="form-label">Email</label
                    ><input
                      type="email"
                      class="form-control"
                      id="register-email"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="register-pseudo" class="form-label"
                      >Pseudo</label
                    ><input
                      type="text"
                      class="form-control"
                      id="register-pseudo"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="register-password" class="form-label"
                      >Mot de passe</label
                    ><input
                      type="password"
                      class="form-control"
                      id="register-password"
                      required
                    />
                  </div>
                  <button type="submit" class="btn btn-success w-100">
                    Créer mon compte
                  </button>
                </form>
                <div
                  id="register-message"
                  class="mt-3 text-center fw-semibold"
                  style="height: 24px"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Fenêtre Modale pour le Magasin -->
    <div
      class="modal fade"
      id="storeModal"
      tabindex="-1"
      aria-labelledby="storeModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="storeModalLabel">
              <i class="bi bi-shop"></i> Magasin
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="store-items-container" class="row g-3">
              <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
            <div
              id="store-message"
              class="mt-3 text-center fw-semibold"
              style="height: 24px"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- État global de l'application ---
      const API_URL = "https://la-peche-du-capitaine-roro-backend.onrender.com";
      let currentUser = null;
      let token = null;

      // --- Références DOM ---
      const playerNameEl = document.getElementById("player-name");
      const playerMoneyEl = document.getElementById("player-money");
      const inventoryListEl = document.getElementById("inventory-list");
      const authButtonsEl = document.getElementById("auth-buttons");
      const loginForm = document.getElementById("login-form");
      const registerForm = document.getElementById("register-form");
      const loginMessageEl = document.getElementById("login-message");
      const registerMessageEl = document.getElementById("register-message");
      const authModalEl = document.getElementById("authModal");
      const authModal = new bootstrap.Modal(authModalEl);
      const castLineBtn = document.getElementById("cast-line-btn");
      const gameStatusEl = document.getElementById("game-status");
      const messageBoxEl = document.getElementById("message-box");
      const storeBtn = document.getElementById("store-btn");
      const storeItemsContainer = document.getElementById(
        "store-items-container"
      );
      const storeMessageEl = document.getElementById("store-message");

      // --- Fonctions de mise à jour de l'UI ---
      async function updateUIForLoggedInUser() {
        playerNameEl.textContent = currentUser.pseudo;
        playerMoneyEl.textContent = `${currentUser.argent} $`;
        authButtonsEl.innerHTML = `<div class="d-flex justify-content-center gap-2"><button id="store-btn" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#storeModal"><i class="bi bi-shop"></i> Magasin</button><button id="logout-btn" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Déconnexion</button></div>`;
        document.getElementById("logout-btn").addEventListener("click", logout);
        document
          .getElementById("store-btn")
          .addEventListener("click", fetchStoreItems);
        castLineBtn.disabled = false;
        gameStatusEl.textContent = "Prêt à pêcher !";
        await fetchInventory();
      }

      function updateUIForLoggedOutUser() {
        playerNameEl.textContent = "Non connecté";
        playerMoneyEl.textContent = "-- $";
        inventoryListEl.innerHTML =
          '<li class="list-group-item text-muted">Connectez-vous pour voir votre inventaire.</li>';
        authButtonsEl.innerHTML = `<div class="d-flex justify-content-center gap-2"><button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#authModal"><i class="bi bi-person-circle"></i> Connexion / Inscription</button><button id="store-btn" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#storeModal" disabled><i class="bi bi-shop"></i> Magasin</button></div>`;
        castLineBtn.disabled = true;
        gameStatusEl.textContent = "Connectez-vous pour jouer !";
      }

      function afficherMessage(element, message, isSuccess = true) {
        element.textContent = message;
        element.className = `mt-3 text-center fw-semibold ${
          isSuccess ? "text-success" : "text-danger"
        }`;
        setTimeout(() => {
          element.textContent = "";
        }, 4000);
      }

      // --- Logique d'authentification ---
      async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        try {
          const response = await fetch(`${API_URL}/api/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.msg);
          localStorage.setItem("token", data.token);
          localStorage.setItem("user", JSON.stringify(data.user));
          currentUser = data.user;
          token = data.token;
          await updateUIForLoggedInUser();
          authModal.hide();
          loginForm.reset();
        } catch (error) {
          afficherMessage(loginMessageEl, error.message, false);
        }
      }

      async function handleRegister(e) {
        e.preventDefault();
        const email = document.getElementById("register-email").value;
        const pseudo = document.getElementById("register-pseudo").value;
        const password = document.getElementById("register-password").value;
        try {
          const response = await fetch(`${API_URL}/api/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, pseudo, password }),
          });

          // AMÉLIORATION DE LA GESTION D'ERREUR
          if (!response.ok) {
            // Si le statut n'est pas 2xx, on essaie de lire l'erreur en JSON
            // S'il n'y a pas de JSON, on affiche un message générique.
            let errorMsg = "Une erreur serveur est survenue.";
            try {
              const errorData = await response.json();
              errorMsg = errorData.msg || errorMsg;
            } catch (jsonError) {
              // Le corps de la réponse n'était pas du JSON, on garde le message générique.
            }
            throw new Error(errorMsg);
          }

          const data = await response.json();
          afficherMessage(
            registerMessageEl,
            data.msg + " Vous pouvez maintenant vous connecter.",
            true
          );
          registerForm.reset();
        } catch (error) {
          afficherMessage(registerMessageEl, error.message, false);
        }
      }

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        currentUser = null;
        token = null;
        updateUIForLoggedOutUser();
      }

      function checkLoginStatus() {
        const storedToken = localStorage.getItem("token");
        const storedUser = localStorage.getItem("user");
        if (storedToken && storedUser) {
          token = storedToken;
          currentUser = JSON.parse(storedUser);
          updateUIForLoggedInUser();
        } else {
          updateUIForLoggedOutUser();
        }
      }

      // --- Logique de jeu ---
      async function handleFish() {
        if (!token) {
          afficherMessage(
            messageBoxEl,
            "Vous devez être connecté pour pêcher.",
            false
          );
          return;
        }
        castLineBtn.disabled = true;
        castLineBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm"></span> Pêche en cours...';
        gameStatusEl.textContent = "La ligne est dans l'eau...";
        try {
          const response = await fetch(`${API_URL}/api/game/fish`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.msg);
          afficherMessage(messageBoxEl, data.msg, true);
          if (data.poisson) {
            currentUser.argent = data.nouvelArgent;
            localStorage.setItem("user", JSON.stringify(currentUser));
            playerMoneyEl.textContent = `${currentUser.argent} $`;
            await fetchInventory();
          }
        } catch (error) {
          afficherMessage(messageBoxEl, error.message, false);
        } finally {
          castLineBtn.disabled = false;
          castLineBtn.textContent = "Lancer la ligne";
          gameStatusEl.textContent = "Prêt à pêcher !";
        }
      }

      async function fetchInventory() {
        if (!token) return;
        try {
          const response = await fetch(`${API_URL}/api/game/inventory`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const inventory = await response.json();
          inventoryListEl.innerHTML = "";
          if (inventory.length === 0) {
            inventoryListEl.innerHTML =
              '<li class="list-group-item text-muted">Aucun poisson pour le moment...</li>';
          } else {
            inventory.forEach((poisson) => {
              const li = document.createElement("li");
              li.className = "list-group-item";
              li.textContent = `${poisson.emoji} ${poisson.nom} - ${poisson.valeur}$`;
              inventoryListEl.appendChild(li);
            });
          }
        } catch (error) {
          console.error(
            "Erreur lors de la récupération de l'inventaire:",
            error
          );
        }
      }

      // --- Logique du Magasin ---
      async function fetchStoreItems() {
        storeItemsContainer.innerHTML = `<div class="text-center"><div class="spinner-border text-primary"></div></div>`;
        try {
          const response = await fetch(`${API_URL}/api/store/items`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const items = await response.json();
          if (!response.ok)
            throw new Error("Impossible de charger le magasin.");
          storeItemsContainer.innerHTML = "";
          if (items.length === 0) {
            storeItemsContainer.innerHTML = `<p class="text-muted">Le magasin est vide pour le moment.</p>`;
            return;
          }
          items.forEach((item) => {
            const itemCard = document.createElement("div");
            itemCard.className = "col-md-6";
            itemCard.innerHTML = `<div class="card h-100"><div class="card-body d-flex justify-content-between align-items-center"><div><h5 class="card-title">${item.emoji} ${item.nom}</h5><p class="card-text small text-muted">${item.description}</p></div><button class="btn btn-success buy-btn" data-item-id="${item.id_equipement_type}" data-item-price="${item.prix}">${item.prix} $</button></div></div>`;
            storeItemsContainer.appendChild(itemCard);
          });
        } catch (error) {
          storeItemsContainer.innerHTML = `<p class="text-danger">${error.message}</p>`;
        }
      }

      async function handleBuyItem(e) {
        if (!e.target.classList.contains("buy-btn")) return;
        const button = e.target;
        const itemId = button.dataset.itemId;
        const itemPrice = parseInt(button.dataset.itemPrice, 10);
        if (currentUser.argent < itemPrice) {
          afficherMessage(
            storeMessageEl,
            "Vous n'avez pas assez d'argent !",
            false
          );
          return;
        }
        button.disabled = true;
        button.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
        try {
          const response = await fetch(`${API_URL}/api/store/buy/${itemId}`, {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.msg);
          currentUser.argent = data.nouvelArgent;
          localStorage.setItem("user", JSON.stringify(currentUser));
          playerMoneyEl.textContent = `${currentUser.argent} $`;
          afficherMessage(storeMessageEl, "Achat réussi !", true);
          button.textContent = "Possédé";
          button.classList.replace("btn-success", "btn-secondary");
        } catch (error) {
          afficherMessage(storeMessageEl, error.message, false);
          button.disabled = false;
          button.textContent = `${itemPrice} $`;
        }
      }

      // --- Écouteurs d'événements ---
      castLineBtn.addEventListener("click", handleFish);
      loginForm.addEventListener("submit", handleLogin);
      registerForm.addEventListener("submit", handleRegister);
      storeItemsContainer.addEventListener("click", handleBuyItem);

      // --- Initialisation ---
      checkLoginStatus();
    </script>
  </body>
</html>
